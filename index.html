<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>EURUSD DNA - TRINITY OS</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700;800&display=swap');
:root{ --bg-primary:#0D1117; --bg-secondary:#161B22; --border-medium:#30363D; --text-secondary:#8B949E; --status-live:#2ECC71; --status-offline:#FF4757; --bar-size: 25px; }
*{margin:0;padding:0;box-sizing:border-box}
body,html{ background:var(--bg-primary); width:100vw; height:100vh; overflow:hidden; font-family: 'JetBrains Mono', monospace; touch-action:none; }
#ui{ position:fixed; top:0; left:0; width:100%; background:var(--bg-secondary); padding:0 20px; z-index:1000; display:flex; align-items:center; border-bottom:1px solid var(--border-medium); height:var(--bar-size); }
.status{ width: 12px; height: 12px; border-radius: 50%; display: block; font-size: 0; background: var(--status-offline); border: 1px solid rgba(255,255,255,0.1); }
.status.live{ background: var(--status-live); box-shadow: 0 0 8px rgba(46, 204, 113, 0.5); animation: pulse 2s infinite; }
.status.history{ background: #3498db; }
@keyframes pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.7; } }
canvas{ display:block; margin-top:var(--bar-size); background:var(--bg-primary); }
#streakPanel,#indexPanel{ position:fixed; top:var(--bar-size); height:calc(100vh - (var(--bar-size) * 2)); background:var(--bg-secondary); border-left:1px solid var(--border-medium); z-index:999; }
#streakPanel{right:75px;width:75px} #indexPanel{right:0;width:75px}
.streak-row{display:flex;width:100%;border-bottom:1px solid #21262D;cursor:pointer;}
.streak-col{flex:1;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:800;padding:3px;font-family: 'JetBrains Mono';}
.streak-col.red-side{background:linear-gradient(135deg, #FF4757 0%, #FF3838 100%);color:#FFF;}
.streak-col.green-side{background:linear-gradient(135deg, #2ECC71 0%, #27AE60 100%);color:#FFF;}
.index-cell{position:absolute;width:100%;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;color:var(--text-secondary);border-bottom:1px solid #21262D;background:var(--bg-secondary);font-family: 'JetBrains Mono';}
#modalOverlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(13,17,23,0.9);z-index:1999;backdrop-filter:blur(6px);}
#modal{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:90vw;max-width:600px;max-height:85vh;background:var(--bg-secondary);border:1px solid var(--border-medium);z-index:2000;flex-direction:column;border-radius:16px;overflow:hidden;}
</style>
</head>
<body>

<div id="ui">
    <div id="status" class="status">OFFLINE</div>
    <div style="margin-left:10px; color:#fff; font-size:10px;">TRINITY OS :: LIVE</div>
</div>

<canvas id="matrixCanvas"></canvas>
<div id="streakPanel"></div>
<div id="indexPanel"></div>

<div id="modalOverlay" onclick="closeModal()"></div>
<div id="modal">
  <div id="modalTitle" style="padding:20px; text-align:center; background:#1C2128; color:#E6EDF3; border-bottom:1px solid #30363D; font-family:'JetBrains Mono'"></div>
  <div style="display:flex; flex:1; overflow:hidden;">
    <div style="flex:1; overflow-y:auto; background:linear-gradient(135deg, #FF4757 0%, #FF3838 100%)"><div id="rD"></div></div>
    <div style="flex:1; overflow-y:auto; background:linear-gradient(135deg, #2ECC71 0%, #27AE60 100%)"><div id="gD"></div></div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCX-bZLDHy-6wxuc5b8YInV_Mr7uYOTmgk",
    authDomain: "trinity-os-8edd0.firebaseapp.com",
    databaseURL: "https://trinity-os-8edd0-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "trinity-os-8edd0",
    storageBucket: "trinity-os-8edd0.firebasestorage.app",
    messagingSenderId: "692349337854",
    appId: "1:692349337854:web:ef24ead6e7362a5772a5af"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const canvas=document.getElementById('matrixCanvas'), ctx=canvas.getContext('2d',{alpha:false,desynchronized:true});
  let matrixData={}, currentColumn=0, cameraX=0, isFollowing=true;
  const CELL_W=65, TOTAL_ROWS=60, MAX_COLS=7200, MARGIN_RIGHT=150, BAR_SIZE=25; 
  let CELL_H=16, cachedStartOfWeek=null, panelUpdateTimer=null;
  const pad=(n,s=2)=>String(n).padStart(s,'0');

  function getWeekProgress(){
    const now = new Date();
    const day = now.getUTCDay();
    const hours = now.getUTCHours();
    const minutes = now.getUTCMinutes();
    const seconds = now.getUTCSeconds();
    const secsToday = (hours * 3600) + (minutes * 60) + seconds;
    let s = (day === 0) ? (6 * 86400) + secsToday : ((day - 1) * 86400) + secsToday;
    return Math.max(0, s);
  }

  function updateCurrentColumn() {
      const s = getWeekProgress();
      currentColumn = Math.floor(s / 60) % MAX_COLS;
      if(isFollowing) jumpToCurrent();
  }

  const dataRef = ref(db, 'matrixData');
  
  onValue(dataRef, (snapshot) => {
    const val = snapshot.val();
    if(val) {
        matrixData = val;
        document.getElementById('status').className = 'status live';
        updateCurrentColumn();
        if(panelUpdateTimer) clearTimeout(panelUpdateTimer);
        panelUpdateTimer = setTimeout(updatePanels, 100);
    }
  });

  function updatePanels(){
    let hS='', hI='';
    for(let r=0; r<TOTAL_ROWS; r++){
      let rM=0, gM=0;
      Object.values(matrixData).forEach(m=>{ if(m[r]){ if(m[r].c==='R') rM=Math.max(rM,m[r].s); else gM=Math.max(gM,m[r].s); }});
      hS+=`<div class="streak-row" onclick="window.openModal(${r})" style="position:absolute;top:${r*CELL_H}px;height:${CELL_H}px"><div class="streak-col red-side">${rM?'x'+rM:'--'}</div><div class="streak-col green-side">${gM?'x'+gM:'--'}</div></div>`;
      hI+=`<div class="index-cell" style="top:${r*CELL_H}px;height:${CELL_H}px">${pad(r)}_${pad(r)}</div>`;
    }
    document.getElementById('streakPanel').innerHTML=hS; 
    document.getElementById('indexPanel').innerHTML=hI;
  }

  window.openModal = function(sec){
    document.getElementById('modalTitle').innerText=`${pad(sec)}_${pad(sec)}`;
    let rL=[], gL=[];
    Object.keys(matrixData).forEach(col => { if(matrixData[col][sec]){ const d = matrixData[col][sec]; if(d.c === 'R') rL.push(d.s); else gL.push(d.s); }});
    const sum=(a)=>{ const c={}; a.forEach(x=>c[x]=(c[x]||0)+1); return Object.keys(c).map(k=>({s:parseInt(k),c:c[k]})).sort((x,y)=>y.s-x.s); };
    document.getElementById('rD').innerHTML = sum(rL).map(i => `<div style="padding:14px;color:#FFF;border-bottom:1px solid rgba(255,255,255,0.1);font-family:'JetBrains Mono'">X${i.s} - ${i.c}</div>`).join('') || '<div style="padding:12px;opacity:0.5">No data</div>';
    document.getElementById('gD').innerHTML = sum(gL).map(i => `<div style="padding:14px;color:#FFF;border-bottom:1px solid rgba(255,255,255,0.1);font-family:'JetBrains Mono'">X${i.s} - ${i.c}</div>`).join('') || '<div style="padding:12px;opacity:0.5">No data</div>';
    document.getElementById('modal').style.display='flex'; 
    document.getElementById('modalOverlay').style.display='block';
  }

  function jumpToCurrent(){ cameraX = Math.max(0, (currentColumn*CELL_W)-(window.innerWidth-MARGIN_RIGHT-CELL_W)); }
  window.closeModal = function(){ document.getElementById('modal').style.display='none'; document.getElementById('modalOverlay').style.display='none'; }

  window.onresize=()=>{ 
    const dpr=window.devicePixelRatio||1; 
    canvas.width=window.innerWidth*dpr; 
    canvas.height=(window.innerHeight - BAR_SIZE)*dpr;
    canvas.style.width=window.innerWidth+'px'; 
    canvas.style.height=(window.innerHeight - BAR_SIZE)+'px';
    ctx.scale(dpr,dpr); 
    CELL_H=(window.innerHeight - (BAR_SIZE * 2))/TOTAL_ROWS;
    cachedStartOfWeek=null;
    jumpToCurrent();
  };

  /* Drag and scroll event listeners have been removed to lock the view */

  function draw(){
    updateCurrentColumn();
    ctx.fillStyle='#0D1117'; ctx.fillRect(0,0,window.innerWidth,window.innerHeight);
    
    if (!cachedStartOfWeek) {
      const now = new Date();
      const diff = now.getUTCDate() - (now.getUTCDay() === 0 ? 6 : now.getUTCDay() - 1);
      cachedStartOfWeek = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), diff, 0, 0, 0, 0));
    }

    ctx.save(); 
    ctx.translate(-cameraX,0);
    let sC=Math.max(0,Math.floor(cameraX/CELL_W)), eC=Math.min(MAX_COLS-1,Math.floor((cameraX+window.innerWidth)/CELL_W)+1);
    
    const beforeCol = currentColumn > 0 ? currentColumn - 1 : MAX_COLS - 1;
    let maxS = 0;
    const beforeData = matrixData[beforeCol];
    if (beforeData) {
      const vals = Object.values(beforeData);
      for(let i=0; i<vals.length; i++) if(vals[i].s > maxS) maxS = vals[i].s;
    }

    /* Grid lines drawing code removed */
    
    ctx.textAlign='center'; 
    ctx.textBaseline='middle';
    ctx.font='bold 11px "JetBrains Mono"';
    const pulseTime = Date.now() / 200;
    
    for(let a=sC; a<=eC; a++){
      const colData = matrixData[a];
      if(!colData) continue;
      const x=a*CELL_W, centerX=x+CELL_W/2;
      const keys = Object.keys(colData);
      
      for(let i=0; i<keys.length; i++){
        const r = keys[i];
        const d = colData[r];
        const isP = (a === beforeCol && d.s === maxS && d.s > 1);
        
        if(isP) {
          const scale = 1.0 + (0.2 * Math.abs(Math.sin(pulseTime)));
          const centerY = r*CELL_H+CELL_H/2;
          ctx.save();
          ctx.translate(centerX, centerY);
          ctx.scale(scale, scale);
          ctx.fillStyle = d.c==='R' ? '#FF4757' : '#2ECC71';
          ctx.fillText('x'+d.s, 0, 0);
          ctx.restore();
        } else {
          ctx.fillStyle = d.c==='R' ? '#FF4757' : '#2ECC71';
          ctx.fillText('x'+d.s, centerX, r*CELL_H+CELL_H/2);
        }
      }
    }

    ctx.restore();
    ctx.fillStyle = '#161B22'; ctx.fillRect(0, TOTAL_ROWS * CELL_H, window.innerWidth, BAR_SIZE);
    ctx.strokeStyle = '#30363D'; ctx.beginPath(); ctx.moveTo(0, TOTAL_ROWS * CELL_H); ctx.lineTo(window.innerWidth, TOTAL_ROWS * CELL_H); ctx.stroke();

    ctx.save();
    ctx.translate(-cameraX, 0);
    ctx.fillStyle='#8B949E'; ctx.font='700 11px "JetBrains Mono"'; ctx.textAlign='center'; ctx.textBaseline='middle'; 
    const barY = (TOTAL_ROWS*CELL_H) + (BAR_SIZE / 2);
    for(let a=sC; a<=eC; a++){
      if (a <= currentColumn) { 
        const lD=new Date(cachedStartOfWeek.getTime()+(a*60000));
        ctx.fillText(`${pad(lD.getUTCHours())}:${pad(lD.getUTCMinutes())}`, a*CELL_W+CELL_W/2, barY);
      }
    }
    ctx.restore(); 
    requestAnimationFrame(draw);
  }

  window.onresize(); 
  draw();
</script>
</body>
</html>
