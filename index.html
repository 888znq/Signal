// ... (Keep the Firebase initialization and setup the same as the previous code)

  function draw() {
    ctx.fillStyle = '#0D1117';
    ctx.fillRect(0, 0, window.innerWidth, window.innerHeight);

    // 1. Establish the Anchor (Monday 00:00 UTC)
    const now = new Date();
    const day = now.getUTCDay();
    const diff = now.getUTCDate() - (day === 0 ? 6 : day - 1);
    const mondayUTC = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), diff, 0, 0, 0, 0));

    ctx.save();
    ctx.translate(-cameraX, 0);

    let sC = Math.max(0, Math.floor(cameraX / CELL_W));
    let eC = Math.min(MAX_COLS - 1, Math.floor((cameraX + window.innerWidth) / CELL_W) + 1);

    // Draw Grid Lines
    ctx.strokeStyle = '#21262D';
    ctx.lineWidth = 1;
    for (let r = 0; r <= TOTAL_ROWS; r++) {
      ctx.beginPath();
      ctx.moveTo(sC * CELL_W, r * CELL_H);
      ctx.lineTo((eC + 1) * CELL_W, r * CELL_H);
      ctx.stroke();
    }

    // Draw Matrix Cells
    for (let a = sC; a <= eC; a++) {
      let x = a * CELL_W;
      if (matrixData[a]) {
        Object.keys(matrixData[a]).forEach(r => {
          const d = matrixData[a][r];
          ctx.fillStyle = d.c === 'R' ? '#FF4757' : '#2ECC71';
          ctx.fillRect(x + 1, r * CELL_H + 1, CELL_W - 2, CELL_H - 2);
          ctx.fillStyle = '#FFFFFF';
          ctx.font = 'bold 9px "JetBrains Mono"';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText('x' + d.s, x + CELL_W / 2, r * CELL_H + CELL_H / 2);
        });
      }
    }
    ctx.restore();

    // --- FORCED IST BOTTOM INDEX ---
    ctx.fillStyle = '#161B22';
    ctx.fillRect(0, TOTAL_ROWS * CELL_H, window.innerWidth, BAR_SIZE);

    ctx.save();
    ctx.translate(-cameraX, 0);
    ctx.fillStyle = '#8B949E';
    ctx.font = '700 10px "JetBrains Mono"';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';

    const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];

    for (let a = sC; a <= eC; a++) {
      let x = a * CELL_W;
      
      // Calculate IST: Monday UTC + (Column Minutes) + 5.5 Hours (330 minutes)
      const istMillis = mondayUTC.getTime() + (a * 60000) + (330 * 60000);
      const istDate = new Date(istMillis);

      // We use getUTC methods on the shifted date to avoid local browser interference
      const dName = days[istDate.getUTCDay()];
      const hrs = pad(istDate.getUTCHours());
      const mins = pad(istDate.getUTCMinutes());

      ctx.fillText(`${dName} ${hrs}:${mins}`, x + CELL_W / 2, (TOTAL_ROWS * CELL_H) + (BAR_SIZE / 2));
    }
    ctx.restore();

    requestAnimationFrame(draw);
  }
