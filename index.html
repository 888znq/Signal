<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>BTCUSD DNA - TRINITY OS</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0D1117">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon-192.png">
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700;800&display=swap');
:root{ 
  --bg-primary:#0D1117; 
  --bg-secondary:#161B22; 
  --border-medium:#30363D; 
  --text-secondary:#8B949E; 
  --status-live:#2ECC71; 
  --status-offline:#FF4757; 
  --bar-size: 25px;
  --analyzer-width: 320px;
  --index-width: 60px;
  --streak-width: 60px;
  --right-margin: calc(var(--analyzer-width) + var(--index-width) + var(--streak-width));
}
*{margin:0;padding:0;box-sizing:border-box}
body,html{ background:var(--bg-primary); width:100vw; height:100vh; overflow:hidden; font-family: 'JetBrains Mono', monospace; touch-action:none; }

/* Top Status Bar */
#ui{ position:fixed; top:0; left:0; width:100%; background:var(--bg-secondary); padding:0 20px; z-index:1000; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid var(--border-medium); height:var(--bar-size); }
.status{ width: 12px; height: 12px; border-radius: 50%; display: block; font-size: 0; background: var(--status-offline); border: 1px solid rgba(255,255,255,0.1); }
.status.live{ background: var(--status-live); box-shadow: 0 0 8px rgba(46, 204, 113, 0.5); animation: pulse 2s infinite; }
.status.history{ background: #3498db; }
@keyframes pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.7; } }

/* Canvas */
canvas{ display:block; margin-top:var(--bar-size); background:var(--bg-primary); }

/* Right Side Panels */
#streakPanel, #indexPanel, #analyzerPanel { 
  position:fixed; 
  top:var(--bar-size); 
  height:calc(100vh - (var(--bar-size) * 2)); 
  background:var(--bg-secondary); 
  border-left:1px solid var(--border-medium); 
  z-index:999; 
}

#analyzerPanel { right:0; width:var(--analyzer-width); overflow-y:auto; }
#indexPanel { right:var(--analyzer-width); width:var(--index-width); }
#streakPanel { right:calc(var(--analyzer-width) + var(--index-width)); width:var(--streak-width); }

/* Streak Panel */
#streakPanel{overflow-y:auto;}
/* NOTE: .streak-row is now positioned absolutely in JS, so flex here is just for internal alignment */
.streak-row{display:flex; align-items:center; width:100%; border-bottom:1px solid #21262D; cursor:pointer;}
.streak-col{flex:1; display:flex; align-items:center; justify-content:center; font-size:9px; font-weight:800; height:100%; font-family: 'JetBrains Mono';}
.streak-col.red-side{background:linear-gradient(135deg, #FF4757 0%, #FF3838 100%);color:#FFF;}
.streak-col.green-side{background:linear-gradient(135deg, #2ECC71 0%, #27AE60 100%);color:#FFF;}

/* Index Panel */
.index-cell{position:absolute; width:100%; display:flex; align-items:center; justify-content:center; font-size:8px; font-weight:700; color:var(--text-secondary); border-bottom:1px solid #21262D; background:var(--bg-secondary); font-family: 'JetBrains Mono';}

/* King Streak Analyzer Panel */
#analyzerPanel {
  display: flex;
  flex-direction: column;
  padding: 12px;
}

.analyzer-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
  padding-bottom: 10px;
  border-bottom: 2px solid var(--border-medium);
}

.results-container {
  flex: 1;
  overflow-y: auto;
}

.results-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 8px;
}

.results-table thead {
  position: sticky;
  top: 0;
  background: var(--bg-secondary);
  z-index: 1;
}

.results-table th {
  color: var(--text-secondary);
  font-weight: 700;
  text-align: left;
  padding: 8px 4px;
  border-bottom: 2px solid var(--border-medium);
  text-transform: uppercase;
  font-size: 7px;
  letter-spacing: 0.5px;
}

.results-table td {
  padding: 7px 4px;
  border-bottom: 1px solid #21262D;
  color: #E6EDF3;
  white-space: nowrap;
}

.results-table td:first-child {
  min-width: 46px;
}

.results-table tr:hover {
  background: rgba(255,255,255,0.03);
}

.no-results {
  text-align: center;
  color: var(--text-secondary);
  padding: 20px 10px;
  font-size: 9px;
}

.analyzer-footer {
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 7px;
  color: var(--text-secondary);
  padding: 8px 0;
  border-top: 1px solid var(--border-medium);
  margin-top: 8px;
}

.refresh-indicator {
  display: flex;
  align-items: center;
  gap: 5px;
}

.refresh-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--status-live);
  box-shadow: 0 0 5px var(--status-live);
}

/* Modal */
#modalOverlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(13,17,23,0.9);z-index:1999;backdrop-filter:blur(6px);}
#modal{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:90vw;max-width:600px;max-height:85vh;background:var(--bg-secondary);border:1px solid var(--border-medium);z-index:2000;flex-direction:column;border-radius:16px;overflow:hidden;}

/* Scrollbar */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: var(--bg-primary); }
::-webkit-scrollbar-thumb { background: var(--border-medium); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: #4A5057; }
</style>
</head>
<body>

<div id="ui">
    <div style="display:flex;align-items:center;">
        <div id="status" class="status">OFFLINE</div>
        <div style="margin-left:10px; color:#fff; font-size:10px;">TRINITY OS :: LIVE</div>
    </div>
    <div style="color:var(--text-secondary); font-size:9px;">KING STREAK ANALYZER</div>
</div>

<canvas id="matrixCanvas"></canvas>

<div id="streakPanel"></div>
<div id="indexPanel"></div>

<div id="analyzerPanel">
    <div class="results-container">
        <table class="results-table" id="results-table">
            <thead>
                <tr>
                    <th>Row</th>
                    <th>Level</th>
                    <th>Cur</th>
                    <th>Nxt</th>
                    <th>Str%</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td colspan="5" class="no-results">Waiting for data...</td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <div class="analyzer-footer">
        <div class="refresh-indicator">
            <div class="refresh-dot"></div>
            <span>SYNC: LIVE</span>
        </div>
        <div id="lastUpdate">--:--:--</div>
    </div>
</div>

<div id="modalOverlay" onclick="closeModal()"></div>
<div id="modal">
  <div id="modalTitle" style="padding:20px; text-align:center; background:#1C2128; color:#E6EDF3; border-bottom:1px solid #30363D; font-family:'JetBrains Mono'"></div>
  <div style="display:flex; flex:1; overflow:hidden;">
    <div style="flex:1; overflow-y:auto; background:linear-gradient(135deg, #FF4757 0%, #FF3838 100%)"><div id="rD"></div></div>
    <div style="flex:1; overflow-y:auto; background:linear-gradient(135deg, #2ECC71 0%, #27AE60 100%)"><div id="gD"></div></div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCX-bZLDHy-6wxuc5b8YInV_Mr7uYOTmgk",
    authDomain: "trinity-os-8edd0.firebaseapp.com",
    databaseURL: "https://trinity-os-8edd0-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "trinity-os-8edd0",
    storageBucket: "trinity-os-8edd0.firebasestorage.app",
    messagingSenderId: "692349337854",
    appId: "1:692349337854:web:ef24ead6e7362a5772a5af"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const canvas=document.getElementById('matrixCanvas'), ctx=canvas.getContext('2d',{alpha:false,desynchronized:true});
  let matrixData={}, currentColumn=0, cameraX=0, isFollowing=true;
  const CELL_W=50, TOTAL_ROWS=60, MAX_COLS=7200, BAR_SIZE=25;
  const RIGHT_MARGIN=440; 
  let CELL_H=16, panelUpdateTimer=null;
  const pad=(n,s=2)=>String(n).padStart(s,'0');

  function getWeekProgress(){
    const now = new Date();
    const day = now.getUTCDay();
    const hours = now.getUTCHours();
    const minutes = now.getUTCMinutes();
    const seconds = now.getUTCSeconds();
    const secsToday = (hours * 3600) + (minutes * 60) + seconds;
    let s = (day === 0) ? (6 * 86400) + secsToday : ((day - 1) * 86400) + secsToday;
    return Math.max(0, s);
  }

  function updateCurrentColumn() {
      const s = getWeekProgress();
      currentColumn = Math.floor(s / 60) % MAX_COLS;
      if(isFollowing) jumpToCurrent();
  }

  const dataRef = ref(db, 'matrixData');
   
  onValue(dataRef, (snapshot) => {
    const val = snapshot.val();
    if(val) {
        matrixData = val;
        document.getElementById('status').className = 'status live';
        updateCurrentColumn();
        
        // Debounce both panel updates slightly to prevent UI freezing
        if(panelUpdateTimer) clearTimeout(panelUpdateTimer);
        panelUpdateTimer = setTimeout(() => {
            updatePanels();
            analyzeKingStreaks(); // SYNCED: Runs immediately after data update
        }, 100);
    }
  });

  function updatePanels(){
    // NO SORTING - Keeps alignment with index panel
    let hS = '';
    let hI = '';
    
    for(let r=0; r<TOTAL_ROWS; r++){
      let rM=0, gM=0;
      Object.values(matrixData).forEach(m=>{ 
        if(m[r]){ 
          if(m[r].c==='R') rM=Math.max(rM,m[r].s); 
          else gM=Math.max(gM,m[r].s); 
        }
      });
      
      const yPos = r * CELL_H;
      
      // Render Streak Row (Red/Green Split)
      // Using absolute positioning to match Index Panel exactly
      hS += `<div class="streak-row" onclick="window.openModal(${r})" 
              style="position:absolute; top:${yPos}px; left:0; width:100%; height:${CELL_H}px; border-bottom:1px solid #21262D;">
                <div class="streak-col red-side">${rM?'x'+rM:'--'}</div>
                <div class="streak-col green-side">${gM?'x'+gM:'--'}</div>
             </div>`;

      // Render Index Row (00_00)
      hI += `<div class="index-cell" style="top:${yPos}px; height:${CELL_H}px; border-bottom:1px solid #21262D;">
                ${pad(r)}_${pad(r)}
             </div>`;
    }
    
    document.getElementById('streakPanel').innerHTML = hS; 
    document.getElementById('indexPanel').innerHTML = hI;
  }

  // UPDATED MODAL FUNCTION: Sorts Ascending (x1 at Top)
  window.openModal = function(sec){
    document.getElementById('modalTitle').innerText=`${pad(sec)}_${pad(sec)}`;
    let rL=[], gL=[];
    
    Object.keys(matrixData).forEach(col => { 
        if(matrixData[col][sec]){ 
            const d = matrixData[col][sec]; 
            if(d.c === 'R') rL.push(d.s); 
            else gL.push(d.s); 
        }
    });

    const sum=(a)=>{ 
        const c={}; 
        a.forEach(x=>c[x]=(c[x]||0)+1); 
        // CHANGED: sort((x,y)=>x.s-y.s) for Ascending Order (Low to High)
        return Object.keys(c).map(k=>({s:parseInt(k),c:c[k]})).sort((x,y)=>x.s-y.s); 
    };

    document.getElementById('rD').innerHTML = sum(rL).map(i => `<div style="padding:14px;color:#FFF;border-bottom:1px solid rgba(255,255,255,0.1);font-family:'JetBrains Mono'">X${i.s} - ${i.c}</div>`).join('') || '<div style="padding:12px;opacity:0.5">No data</div>';
    document.getElementById('gD').innerHTML = sum(gL).map(i => `<div style="padding:14px;color:#FFF;border-bottom:1px solid rgba(255,255,255,0.1);font-family:'JetBrains Mono'">X${i.s} - ${i.c}</div>`).join('') || '<div style="padding:12px;opacity:0.5">No data</div>';
    
    document.getElementById('modal').style.display='flex'; 
    document.getElementById('modalOverlay').style.display='block';
  }

  function jumpToCurrent(){ 
    cameraX = Math.max(0, (currentColumn*CELL_W)-(window.innerWidth-RIGHT_MARGIN-CELL_W)); 
  }
   
  window.closeModal = function(){ document.getElementById('modal').style.display='none'; document.getElementById('modalOverlay').style.display='none'; }

  window.onresize=()=>{ 
    const dpr=window.devicePixelRatio||1; 
    canvas.width=(window.innerWidth - RIGHT_MARGIN)*dpr; 
    canvas.height=(window.innerHeight - BAR_SIZE)*dpr;
    canvas.style.width=(window.innerWidth - RIGHT_MARGIN)+'px'; 
    canvas.style.height=(window.innerHeight - BAR_SIZE)+'px';
    ctx.scale(dpr,dpr); 
    CELL_H=(window.innerHeight - (BAR_SIZE * 2))/TOTAL_ROWS;
    jumpToCurrent();
  };

  function draw(){
    updateCurrentColumn();
    ctx.fillStyle='#0D1117'; ctx.fillRect(0,0,window.innerWidth-RIGHT_MARGIN,window.innerHeight);
    const IST_OFFSET_MINS = 330;
    ctx.save(); 
    ctx.translate(-cameraX,0);
    let sC=Math.max(0,Math.floor(cameraX/CELL_W)), eC=Math.min(MAX_COLS-1,Math.floor((cameraX+window.innerWidth-RIGHT_MARGIN)/CELL_W)+1);
    const beforeCol = currentColumn > 0 ? currentColumn - 1 : MAX_COLS - 1;
    let maxS = 0;
    const beforeData = matrixData[beforeCol];
    if (beforeData) {
      const vals = Object.values(beforeData);
      for(let i=0; i<vals.length; i++) if(vals[i].s > maxS) maxS = vals[i].s;
    }
    ctx.font='bold 10px "JetBrains Mono"'; ctx.textAlign='center'; ctx.textBaseline='middle';
    const pulseTime = Date.now() / 200;
    for(let a=sC; a<=eC; a++){
      const colData = matrixData[a];
      if(!colData) continue;
      const x=a*CELL_W;
      Object.keys(colData).forEach(r=>{
        const d=colData[r];
        const isP = (a === beforeCol && d.s === maxS && d.s > 1);
        const scale = isP ? (1.0 + (0.2 * Math.abs(Math.sin(pulseTime)))) : 1;
        ctx.fillStyle = d.c==='R' ? '#FF4757' : '#2ECC71';
        if(isP){
          ctx.save();
          ctx.translate(x+CELL_W/2, r*CELL_H+CELL_H/2);
          ctx.scale(scale, scale);
          ctx.fillText('x'+d.s, 0, 0);
          ctx.restore();
        } else {
          ctx.fillText('x'+d.s, x+CELL_W/2, r*CELL_H+CELL_H/2);
        }
      });
    }
    ctx.restore();
    ctx.fillStyle = '#161B22'; ctx.fillRect(0, TOTAL_ROWS * CELL_H, window.innerWidth-RIGHT_MARGIN, BAR_SIZE);
    ctx.strokeStyle = '#30363D'; ctx.beginPath(); ctx.moveTo(0, TOTAL_ROWS * CELL_H); ctx.lineTo(window.innerWidth-RIGHT_MARGIN, TOTAL_ROWS * CELL_H); ctx.stroke();
    ctx.save();
    ctx.translate(-cameraX, 0);
    ctx.fillStyle='#8B949E'; ctx.font='700 10px "JetBrains Mono"'; ctx.textAlign='center'; ctx.textBaseline='middle'; 
    const barY = (TOTAL_ROWS*CELL_H) + (BAR_SIZE / 2);
    for(let a=sC; a<=eC; a++){
      if (a <= currentColumn) {
        const totalMins = (a + IST_OFFSET_MINS) % (7 * 24 * 60);
        const h = Math.floor(totalMins / 60) % 24;
        const m = totalMins % 60;
        ctx.fillText(`${pad(h)}:${pad(m)}`, a*CELL_W+CELL_W/2, barY);
      }
    }
    ctx.restore(); 
    requestAnimationFrame(draw);
  }
  window.onresize(); 
  draw();
  window.getMatrixData = () => matrixData;
</script>

<script>
// King Streak Analyzer - REAL TIME SYNCED
function analyzeKingStreaks() {
    // Get fresh data directly
    const matrixData = window.getMatrixData();
    
    if (!matrixData || Object.keys(matrixData).length === 0) {
        return;
    }
    
    let streakKings = {};
    
    // Analyze all rows (0-59)
    for (let row = 0; row < 60; row++) {
        let redStreaks = {};
        let greenStreaks = {};
        
        // Optimisation: Iterate keys directly instead of sorting every time for speed
        // The order of keys doesn't matter for counting totals
        const columns = Object.keys(matrixData);
        
        for (let col of columns) {
            const cellData = matrixData[col][row];
            if (!cellData) continue;
            
            const color = cellData.c;
            const streak = cellData.s;
            
            if (color === 'R') {
                redStreaks[streak] = (redStreaks[streak] || 0) + 1;
            } else if (color === 'G') {
                greenStreaks[streak] = (greenStreaks[streak] || 0) + 1;
            }
        }
        
        // Calculate strengths
        ['Red', 'Green'].forEach(color => {
            let d = color === 'Red' ? redStreaks : greenStreaks;
            Object.keys(d).forEach(lStr => {
                let l = parseInt(lStr);
                let count = d[l];
                let nxt = d[l+1] || 0;
                
                // STRENGTH FORMULA: Probability of breaking
                let strength = (1 - (nxt/count)) * 100;
                
                if (strength >= 1 && strength <= 100) {
                    let key = `${color}-${l}`;
                    if (!streakKings[key] || count > streakKings[key].cur) {
                        streakKings[key] = { 
                            row: row,
                            col: color,
                            lvl: `X${l}â†’X${l+1}`,
                            s: parseFloat(strength.toFixed(1)),
                            cur: count,
                            nxt: nxt
                        };
                    }
                }
            });
        });
    }
    
    renderResults(streakKings);
    updateLastRefreshTime();
}

function renderResults(kings) {
    const tbody = document.querySelector('#results-table tbody');
    tbody.innerHTML = '';
    
    const sorted = Object.values(kings).sort((a, b) => b.cur - a.cur);
    
    if (sorted.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="no-results">No patterns found</td></tr>';
        return;
    }
    
    sorted.forEach(k => {
        const tr = document.createElement('tr');
        const color = k.col === 'Green' ? '#2ECC71' : '#FF4757';
        tr.innerHTML = `
            <td style="color:${color};font-weight:700">${k.row.toString().padStart(2,'0')}_${k.row.toString().padStart(2,'0')}</td>
            <td style="color:${color};font-weight:700">${k.lvl}</td>
            <td style="color:${color};font-weight:700">${k.cur}</td>
            <td style="color:${color};font-weight:700">${k.nxt}</td>
            <td style="color:${color};font-weight:700">${k.s}%</td>
        `;
        tbody.appendChild(tr);
    });
}

function updateLastRefreshTime() {
    const now = new Date();
    const time = now.toLocaleTimeString('en-US', { hour12: false });
    document.getElementById('lastUpdate').textContent = time;
}

// Service Worker Registration
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js');
  });
}
</script>

</body>
</html>
