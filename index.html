<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>TRINITY OS - DEEP SCAN</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0D1117">
<meta name="mobile-web-app-capable" content="yes">
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700;800&display=swap');
:root{ --bg-primary:#0D1117; --bg-secondary:#161B22; --border-medium:#30363D; --text-secondary:#8B949E; --status-live:#2ECC71; --status-offline:#FF4757; --bar-size: 40px; }
*{margin:0;padding:0;box-sizing:border-box;outline:none;}
body,html{ background:var(--bg-primary); width:100vw; height:100vh; overflow:hidden; font-family: 'JetBrains Mono', monospace; touch-action:none; }

/* UI BAR */
#ui{ position:fixed; top:0; left:0; width:100%; background:var(--bg-secondary); padding:0 10px; z-index:1000; display:flex; align-items:center; gap: 10px; border-bottom:1px solid var(--border-medium); height:var(--bar-size); }
.control-group { display:flex; align-items:center; gap: 5px; background: #0D1117; padding: 4px 8px; border-radius: 4px; border: 1px solid #30363D; }
input[type="number"] { background: transparent; border: none; color: #E6EDF3; font-family: 'JetBrains Mono'; font-size: 12px; width: 40px; text-align: center; font-weight: 700; }
button { background: #238636; border: none; color: white; font-family: 'JetBrains Mono'; font-size: 10px; font-weight: 700; padding: 6px 10px; border-radius: 4px; cursor: pointer; }
button:hover { background: #2EA043; }
button.lock { background: #1F6FEB; }
.status{ width: 10px; height: 10px; border-radius: 50%; display: block; background: var(--status-offline); margin-left: auto; border: 1px solid rgba(255,255,255,0.1); }
.status.live{ background: var(--status-live); box-shadow: 0 0 8px rgba(46, 204, 113, 0.5); animation: pulse 2s infinite; }
.status.loading{ background: #E67E22; animation: pulse 0.5s infinite; }
@keyframes pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.7; } }

/* CANVAS & PANELS */
canvas{ display:block; margin-top:var(--bar-size); background:var(--bg-primary); }
#streakPanel,#indexPanel{ position:fixed; top:var(--bar-size); height:calc(100vh - var(--bar-size)); background:var(--bg-secondary); border-left:1px solid var(--border-medium); z-index:999; }
#streakPanel{right:75px;width:75px} #indexPanel{right:0;width:75px}
.streak-row{display:flex;width:100%;border-bottom:1px solid #21262D;cursor:pointer;}
.streak-col{flex:1;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:800;padding:0;font-family: 'JetBrains Mono';}
.streak-col.red-side{background:linear-gradient(135deg, #FF4757 0%, #FF3838 100%);color:#FFF;}
.streak-col.green-side{background:linear-gradient(135deg, #2ECC71 0%, #27AE60 100%);color:#FFF;}
.index-cell{position:absolute;width:100%;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;color:var(--text-secondary);border-bottom:1px solid #21262D;background:var(--bg-secondary);font-family: 'JetBrains Mono';}

/* MODAL */
#modalOverlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(13,17,23,0.9);z-index:1999;backdrop-filter:blur(6px);}
#modal{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:90vw;max-width:600px;max-height:85vh;background:var(--bg-secondary);border:1px solid var(--border-medium);z-index:2000;flex-direction:column;border-radius:16px;overflow:hidden;}
</style>
</head>
<body>

<div id="ui">
    <div class="control-group">
        <span style="color:#8B949E; font-size:10px;">CYCLE:</span>
        <input type="number" id="cycleInput" value="60" min="10" max="900">
    </div>
    <button onclick="applyCycle()" id="btnApply">APPLY</button>
    <button onclick="toggleLock()" id="btnLock" class="lock">LOCK</button>
    <div id="status" class="status"></div>
</div>

<canvas id="matrixCanvas"></canvas>
<div id="streakPanel"></div>
<div id="indexPanel"></div>

<div id="modalOverlay" onclick="closeModal()"></div>
<div id="modal">
  <div id="modalTitle" style="padding:20px; text-align:center; background:#1C2128; color:#E6EDF3; border-bottom:1px solid #30363D; font-family:'JetBrains Mono'"></div>
  <div style="display:flex; flex:1; overflow:hidden;">
    <div style="flex:1; overflow-y:auto; background:linear-gradient(135deg, #FF4757 0%, #FF3838 100%)"><div id="rD"></div></div>
    <div style="flex:1; overflow-y:auto; background:linear-gradient(135deg, #2ECC71 0%, #27AE60 100%)"><div id="gD"></div></div>
  </div>
</div>

<script>
const canvas=document.getElementById('matrixCanvas'), ctx=canvas.getContext('2d',{alpha:false});
const SYMBOL="frxEURUSD", TOKEN="TpVIBWpqet5X8AH", DERIV_WS="wss://ws.derivws.com/websockets/v3?app_id=1089";

// GLOBALS
let CYCLE = 60; 
let TOTAL_ROWS = 60; 
let CELL_H = 16; 
let matrixData={}, currentColumn=0, cameraX=0, isFollowing=true, ws=null, isLocked=false;
// DEEP HISTORY STATE
let tickBacklog = [];
let historyDepth = 0;
const TARGET_DEPTH = 3; // 3 chunks of 5000 = 15,000 ticks

const CELL_W=65, MAX_COLS=7200, MARGIN_RIGHT=150, BAR_SIZE=40, BOTTOM_BAR=20;
const pad=(n,s=2)=>String(n).padStart(s,'0');

function getWeekProgress(epochTime){
  const now = epochTime ? new Date(epochTime * 1000) : new Date();
  const day = now.getUTCDay(); 
  const secsToday = (now.getUTCHours() * 3600) + (now.getUTCMinutes() * 60) + now.getUTCSeconds();
  let s = (day === 0) ? (6 * 86400) + secsToday : ((day - 1) * 86400) + secsToday;
  return Math.max(0, s);
}

function handleTick(tick){
  const t = tick.epoch;
  const p = tick.quote;
  const s = getWeekProgress(t); 
  currentColumn = Math.floor(s / CYCLE) % MAX_COLS; 
  const r = s % CYCLE; 
  
  if(!matrixData[currentColumn]) matrixData[currentColumn]={};
  const prevC = currentColumn > 0 ? currentColumn - 1 : MAX_COLS - 1;
  let col='G', stk=1;
  
  if(matrixData[prevC] && matrixData[prevC][r]){
    const old = matrixData[prevC][r];
    if(p > old.p){ 
        col = 'G'; 
        stk = (old.c === 'G' ? old.s + 1 : 1); 
    }
    else if(p < old.p){ 
        col = 'R'; 
        stk = (old.c === 'R' ? old.s + 1 : 1); 
    }
    else { 
        // FLAT PRICE (x0 LOGIC)
        col = old.c; 
        stk = 0; // Display x0 instead of x1
    }
  }
  
  matrixData[currentColumn][r] = {c:col, s:stk, p:p};
  if(!tick.isHistory) { updatePanels(); if(isFollowing) jumpToCurrent(); }
}

function toggleLock() {
    isLocked = !isLocked;
    const inp = document.getElementById('cycleInput');
    const btn = document.getElementById('btnApply');
    const lockBtn = document.getElementById('btnLock');
    inp.disabled = isLocked; btn.disabled = isLocked;
    lockBtn.innerText = isLocked ? "LOCKED" : "LOCK";
    lockBtn.style.background = isLocked ? "#8250DF" : "#1F6FEB";
}

function applyCycle() {
    if(isLocked) return;
    const val = parseInt(document.getElementById('cycleInput').value);
    if(!val || val < 10) return alert("Cycle too small (min 10)");
    CYCLE = val; TOTAL_ROWS = val;
    matrixData = {}; tickBacklog = []; historyDepth = 0; // Reset Deep Scan
    document.getElementById('streakPanel').innerHTML = '';
    document.getElementById('indexPanel').innerHTML = '';
    onResize();
    connect(true); 
}

function updatePanels(){
  let hS='', hI='';
  for(let r=0; r<TOTAL_ROWS; r++){
    let rM=0, gM=0;
    Object.values(matrixData).forEach(m=>{ if(m[r]){ if(m[r].c==='R') rM=Math.max(rM,m[r].s); else gM=Math.max(gM,m[r].s); }});
    hS+=`<div class="streak-row" onclick="openModal(${r})" style="position:absolute;top:${r*CELL_H}px;height:${CELL_H}px"><div class="streak-col red-side">${rM?'x'+rM:'--'}</div><div class="streak-col green-side">${gM?'x'+gM:'--'}</div></div>`;
    hI+=`<div class="index-cell" style="top:${r*CELL_H}px;height:${CELL_H}px; font-size:${Math.min(9, CELL_H-2)}px">${pad(r)}</div>`;
  }
  document.getElementById('streakPanel').innerHTML=hS; 
  document.getElementById('indexPanel').innerHTML=hI;
}

function openModal(sec){
  document.getElementById('modalTitle').innerText=`OFFSET: ${pad(sec)}`;
  let rL=[], gL=[];
  Object.keys(matrixData).forEach(col => { if(matrixData[col][sec]){ const d = matrixData[col][sec]; if(d.c === 'R') rL.push(d.s); else gL.push(d.s); }});
  const sum=(a)=>{ const c={}; a.forEach(x=>c[x]=(c[x]||0)+1); return Object.keys(c).map(k=>({s:parseInt(k),c:c[k]})).sort((x,y)=>y.s-x.s); };
  document.getElementById('rD').innerHTML = sum(rL).map(i => `<div style="padding:14px;color:#FFF;border-bottom:1px solid rgba(255,255,255,0.1);font-family:'JetBrains Mono'">X${i.s} - ${i.c}</div>`).join('') || '<div style="padding:12px;opacity:0.5">No data</div>';
  document.getElementById('gD').innerHTML = sum(gL).map(i => `<div style="padding:14px;color:#FFF;border-bottom:1px solid rgba(255,255,255,0.1);font-family:'JetBrains Mono'">X${i.s} - ${i.c}</div>`).join('') || '<div style="padding:12px;opacity:0.5">No data</div>';
  document.getElementById('modal').style.display='flex'; document.getElementById('modalOverlay').style.display='block';
}

function jumpToCurrent(){ cameraX = Math.max(0, (currentColumn*CELL_W)-(window.innerWidth-MARGIN_RIGHT-CELL_W)); }
function closeModal(){ document.getElementById('modal').style.display='none'; document.getElementById('modalOverlay').style.display='none'; }

function onResize(){ 
  const dpr=window.devicePixelRatio||1; 
  canvas.width=window.innerWidth*dpr; canvas.height=(window.innerHeight - BAR_SIZE)*dpr;
  canvas.style.width=window.innerWidth+'px'; canvas.style.height=(window.innerHeight - BAR_SIZE)+'px';
  ctx.scale(dpr,dpr); 
  CELL_H = (window.innerHeight - BAR_SIZE - BOTTOM_BAR) / TOTAL_ROWS;
  updatePanels(); 
}
window.onresize=onResize;

function connect(restart=false){
  if(ws && ws.readyState === WebSocket.OPEN) ws.close();
  ws=new WebSocket(DERIV_WS);
  ws.onopen=()=>{ ws.send(JSON.stringify({authorize:TOKEN})); };
  ws.onmessage=(m)=>{ 
    const d=JSON.parse(m.data); 
    if(d.authorize){ 
        document.getElementById('status').classList.remove('live'); 
        document.getElementById('status').classList.add('loading'); // Orange Status = Loading
        historyDepth = 0; tickBacklog = [];
        // REQ 1: Get Latest
        ws.send(JSON.stringify({ ticks_history: SYMBOL, adjust_start_time: 1, count: 5000, end: "latest", start: 1, style: "ticks" }));
    } 
    if(d.history){
        const times = d.history.times; const prices = d.history.prices;
        const newTicks = times.map((t, i) => ({epoch: t, quote: prices[i], isHistory: true}));
        
        tickBacklog = tickBacklog.concat(newTicks);
        historyDepth++;
        
        // Deep Scan Logic: If we haven't reached depth target and got full batch, ask for more
        if(historyDepth < TARGET_DEPTH && times.length >= 4900){
            const oldestEpoch = times[0]; // Oldest is at 0
            ws.send(JSON.stringify({ ticks_history: SYMBOL, adjust_start_time: 1, count: 5000, end: oldestEpoch - 1, start: 1, style: "ticks" }));
        } else {
            // Process Backlog
            document.getElementById('status').classList.remove('loading');
            document.getElementById('status').classList.add('live');
            
            // SORT needed because requests return chunks in reverse order of requests
            tickBacklog.sort((a,b) => a.epoch - b.epoch);
            
            // Run Calculations
            tickBacklog.forEach(t => handleTick(t));
            
            updatePanels(); jumpToCurrent();
            ws.send(JSON.stringify({ticks:SYMBOL, subscribe:1}));
        }
    }
    if(d.tick) handleTick(d.tick); 
  };
  ws.onclose=()=>{ document.getElementById('status').classList.remove('live'); if(!restart) setTimeout(connect,3000); };
}

function draw(){
  ctx.fillStyle='#0D1117'; ctx.fillRect(0,0,window.innerWidth,window.innerHeight);
  const now = new Date(); const day = now.getDay();
  const diff = now.getDate() - day + (day === 0 ? -6 : 1);
  const startOfWeek = new Date(now.setDate(diff)); startOfWeek.setHours(0,0,0,0);

  ctx.save(); ctx.translate(-cameraX,0);
  let sC=Math.max(0,Math.floor(cameraX/CELL_W)), eC=Math.min(MAX_COLS-1,Math.floor((cameraX+window.innerWidth)/CELL_W)+1);
  
  const beforeCol = currentColumn > 0 ? currentColumn - 1 : MAX_COLS - 1;
  let maxS = 0;
  if (matrixData[beforeCol]) Object.values(matrixData[beforeCol]).forEach(d => { if (d.s > maxS) maxS = d.s; });

  const fontSize = Math.max(8, Math.min(11, CELL_H - 2));

  for(let a=sC; a<=eC; a++){
    let x=a*CELL_W;
    if(matrixData[a]) Object.keys(matrixData[a]).forEach(rStr=>{
      const r = parseInt(rStr); if(r >= TOTAL_ROWS) return; 
      const d=matrixData[a][r];
      const isP = (a === beforeCol && d.s === maxS && d.s > 1);
      const scale = isP ? (1.0 + (0.2 * Math.abs(Math.sin(Date.now() / 200)))) : 1;
      ctx.save();
      if(isP) { ctx.translate(x+CELL_W/2, r*CELL_H+CELL_H/2); ctx.scale(scale, scale); ctx.translate(-(x+CELL_W/2), -(r*CELL_H+CELL_H/2)); }
      ctx.fillStyle = d.c === 'R' ? '#FF4757' : '#2ECC71'; 
      ctx.font=`bold ${fontSize}px "JetBrains Mono"`; ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillText('x'+d.s, x+CELL_W/2, r*CELL_H+CELL_H/2);
      ctx.restore();
    });
    // HH:MM Label
    if(a <= currentColumn) {
        const timeMs = startOfWeek.getTime() + (a * CYCLE * 1000);
        const dObj = new Date(timeMs);
        const label = `${pad(dObj.getHours())}:${pad(dObj.getMinutes())}`;
        ctx.fillStyle='#8B949E'; ctx.font='700 10px "JetBrains Mono"'; ctx.textAlign='center'; ctx.textBaseline='middle'; 
        ctx.fillText(label, x + CELL_W/2, (TOTAL_ROWS * CELL_H) + (BOTTOM_BAR / 2));
    }
  }
  ctx.restore();
  ctx.strokeStyle = '#30363D'; ctx.beginPath(); ctx.moveTo(0, TOTAL_ROWS * CELL_H); ctx.lineTo(window.innerWidth, TOTAL_ROWS * CELL_H); ctx.stroke();
  requestAnimationFrame(draw);
}

onResize(); connect(); draw();
</script>
</body>
</html>
