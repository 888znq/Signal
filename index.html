<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>EURUSD DNA - TRINITY OS</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0D1117">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon-192.png">
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700;800&display=swap');
:root{ 
  --bg-primary:#0D1117; 
  --bg-secondary:#161B22; 
  --border-medium:#30363D; 
  --text-secondary:#8B949E; 
  --status-live:#2ECC71; 
  --status-offline:#FF4757; 
  --bar-size: 25px;
  --analyzer-width: 320px;
  --index-width: 60px;
  --streak-width: 60px;
  --right-margin: calc(var(--analyzer-width) + var(--index-width) + var(--streak-width));
}
*{margin:0;padding:0;box-sizing:border-box}
body,html{ background:var(--bg-primary); width:100vw; height:100vh; overflow:hidden; font-family: 'JetBrains Mono', monospace; touch-action:none; }

/* Top Status Bar */
#ui{ position:fixed; top:0; left:0; width:100%; background:var(--bg-secondary); padding:0 20px; z-index:1000; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid var(--border-medium); height:var(--bar-size); }
.status{ width: 12px; height: 12px; border-radius: 50%; display: block; font-size: 0; background: var(--status-offline); border: 1px solid rgba(255,255,255,0.1); }
.status.live{ background: var(--status-live); box-shadow: 0 0 8px rgba(46, 204, 113, 0.5); animation: pulse 2s infinite; }
.status.history{ background: #3498db; }
@keyframes pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.7; } }

/* Canvas */
canvas{ display:block; margin-top:var(--bar-size); background:var(--bg-primary); }

/* Right Side Panels */
#streakPanel, #indexPanel, #analyzerPanel { 
  position:fixed; 
  top:var(--bar-size); 
  height:calc(100vh - (var(--bar-size) * 2)); 
  background:var(--bg-secondary); 
  border-left:1px solid var(--border-medium); 
  z-index:999; 
}

#analyzerPanel { right:0; width:var(--analyzer-width); overflow-y:auto; }
#indexPanel { right:var(--analyzer-width); width:var(--index-width); }
#streakPanel { right:calc(var(--analyzer-width) + var(--index-width)); width:var(--streak-width); }

/* Streak Panel */
#streakPanel{overflow-y:auto;}
.streak-row{display:flex;width:100%;border-bottom:1px solid #21262D;cursor:pointer;}
.streak-col{flex:1;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:800;padding:2px;font-family: 'JetBrains Mono';}
.streak-col.red-side{background:linear-gradient(135deg, #FF4757 0%, #FF3838 100%);color:#FFF;}
.streak-col.green-side{background:linear-gradient(135deg, #2ECC71 0%, #27AE60 100%);color:#FFF;}

/* Index Panel */
.index-cell{position:absolute;width:100%;display:flex;align-items:center;justify-content:center;font-size:8px;font-weight:700;color:var(--text-secondary);border-bottom:1px solid #21262D;background:var(--bg-secondary);font-family: 'JetBrains Mono';}

/* King Streak Analyzer Panel */
#analyzerPanel {
  display: flex;
  flex-direction: column;
  padding: 12px;
}

.analyzer-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
  padding-bottom: 10px;
  border-bottom: 2px solid var(--border-medium);
}

.analyzer-header h3 {
  color: #E6EDF3;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.analyzer-header .badge {
  background: var(--status-live);
  color: #000;
  font-size: 8px;
  font-weight: 800;
  padding: 3px 8px;
  border-radius: 3px;
  letter-spacing: 0.5px;
}

.mode-display {
  background: var(--bg-primary);
  border: 1px solid var(--border-medium);
  padding: 8px 10px;
  margin-bottom: 12px;
  border-radius: 4px;
  font-size: 9px;
  color: var(--text-secondary);
}

.mode-display .mode-label {
  color: #E6EDF3;
  font-weight: 700;
  margin-right: 5px;
}

.mode-display .mode-value {
  color: var(--status-live);
  font-weight: 700;
}

.results-container {
  flex: 1;
  overflow-y: auto;
}

.results-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 8px;
}

.results-table thead {
  position: sticky;
  top: 0;
  background: var(--bg-secondary);
  z-index: 1;
}

.results-table th {
  color: var(--text-secondary);
  font-weight: 700;
  text-align: left;
  padding: 8px 4px;
  border-bottom: 2px solid var(--border-medium);
  text-transform: uppercase;
  font-size: 7px;
  letter-spacing: 0.5px;
}

.results-table td {
  padding: 7px 4px;
  border-bottom: 1px solid #21262D;
  color: #E6EDF3;
}

.results-table tr.res-green {
  background: rgba(46, 204, 113, 0.05);
}

.results-table tr.res-green td:first-child {
  color: var(--status-live);
  font-weight: 700;
}

.results-table tr.res-red {
  background: rgba(255, 71, 87, 0.05);
}

.results-table tr.res-red td:first-child {
  color: var(--status-offline);
  font-weight: 700;
}

.results-table tr:hover {
  background: rgba(255,255,255,0.05);
}

.no-results {
  text-align: center;
  color: var(--text-secondary);
  padding: 20px 10px;
  font-size: 9px;
}

.analyzer-footer {
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 7px;
  color: var(--text-secondary);
  padding: 8px 0;
  border-top: 1px solid var(--border-medium);
  margin-top: 8px;
}

.refresh-indicator {
  display: flex;
  align-items: center;
  gap: 5px;
}

.refresh-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--status-live);
  animation: blink 1s infinite;
}

@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}

/* Modal */
#modalOverlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(13,17,23,0.9);z-index:1999;backdrop-filter:blur(6px);}
#modal{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:90vw;max-width:600px;max-height:85vh;background:var(--bg-secondary);border:1px solid var(--border-medium);z-index:2000;flex-direction:column;border-radius:16px;overflow:hidden;}

/* Reset Button */
.reset-button {
  background: var(--status-offline);
  color: #FFFFFF;
  border: none;
  padding: 4px 10px;
  font-size: 9px;
  font-weight: 700;
  font-family: 'JetBrains Mono', monospace;
  border-radius: 3px;
  cursor: pointer;
  transition: all 0.2s ease;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.reset-button:hover {
  background: #E74C3C;
  box-shadow: 0 0 8px rgba(255, 71, 87, 0.5);
  transform: translateY(-1px);
}

.reset-button:active {
  transform: translateY(0);
}

.reset-button:disabled {
  background: #4A5057;
  cursor: not-allowed;
  opacity: 0.5;
}

/* Confirmation Dialog */
.confirm-dialog {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: var(--bg-secondary);
  border: 2px solid var(--status-offline);
  border-radius: 8px;
  padding: 20px;
  z-index: 2001;
  min-width: 300px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
  display: none;
}

.confirm-dialog.show {
  display: block;
  animation: slideDown 0.2s ease;
}

@keyframes slideDown {
  from { transform: translate(-50%, -60%); opacity: 0; }
  to { transform: translate(-50%, -50%); opacity: 1; }
}

.confirm-dialog h3 {
  color: var(--status-offline);
  font-size: 14px;
  margin-bottom: 12px;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.confirm-dialog p {
  color: #E6EDF3;
  font-size: 11px;
  margin-bottom: 18px;
  line-height: 1.5;
}

.confirm-dialog-buttons {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
}

.confirm-dialog button {
  padding: 6px 14px;
  font-size: 10px;
  font-weight: 700;
  font-family: 'JetBrains Mono', monospace;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s ease;
  text-transform: uppercase;
}

.confirm-cancel {
  background: var(--border-medium);
  color: #E6EDF3;
}

.confirm-cancel:hover {
  background: #4A5057;
}

.confirm-reset {
  background: var(--status-offline);
  color: #FFFFFF;
}

.confirm-reset:hover {
  background: #E74C3C;
  box-shadow: 0 0 8px rgba(255, 71, 87, 0.5);
}

/* Scrollbar */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: var(--bg-primary); }
::-webkit-scrollbar-thumb { background: var(--border-medium); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: #4A5057; }
</style>
</head>
<body>

<div id="ui">
    <div style="display:flex;align-items:center;">
        <div id="status" class="status">OFFLINE</div>
        <div style="margin-left:10px; color:#fff; font-size:10px;">TRINITY OS :: LIVE</div>
    </div>
    <div style="display:flex;align-items:center;gap:15px;">
        <button id="resetButton" class="reset-button" title="Reset all matrix data">üóëÔ∏è Reset DB</button>
        <div style="color:var(--text-secondary); font-size:9px;">KING STREAK ANALYZER</div>
    </div>
</div>

<canvas id="matrixCanvas"></canvas>

<div id="streakPanel"></div>
<div id="indexPanel"></div>

<!-- King Streak Analyzer Panel -->
<div id="analyzerPanel">
    <div class="results-container">
        <table class="results-table" id="results-table">
            <thead>
                <tr>
                    <th>Type</th>
                    <th>Row</th>
                    <th>Level</th>
                    <th>Cur</th>
                    <th>Nxt</th>
                    <th>Str%</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td colspan="6" class="no-results">Waiting for data...</td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <div class="analyzer-footer">
        <div class="refresh-indicator">
            <div class="refresh-dot"></div>
            <span>Auto-refresh: <span id="countdown">60</span>s</span>
        </div>
        <div id="lastUpdate">Never</div>
    </div>
</div>

<!-- Modal -->
<div id="modalOverlay" onclick="closeModal()"></div>
<div id="modal">
  <div id="modalTitle" style="padding:20px; text-align:center; background:#1C2128; color:#E6EDF3; border-bottom:1px solid #30363D; font-family:'JetBrains Mono'"></div>
  <div style="display:flex; flex:1; overflow:hidden;">
    <div style="flex:1; overflow-y:auto; background:linear-gradient(135deg, #FF4757 0%, #FF3838 100%)"><div id="rD"></div></div>
    <div style="flex:1; overflow-y:auto; background:linear-gradient(135deg, #2ECC71 0%, #27AE60 100%)"><div id="gD"></div></div>
  </div>
</div>

<!-- Reset Confirmation Dialog -->
<div id="confirmDialog" class="confirm-dialog">
  <h3>‚ö†Ô∏è Reset Database</h3>
  <p>This will permanently delete all matrix data from Firebase. This action cannot be undone. Are you sure you want to continue?</p>
  <div class="confirm-dialog-buttons">
    <button class="confirm-cancel" onclick="closeConfirmDialog()">Cancel</button>
    <button class="confirm-reset" onclick="confirmReset()">Reset Database</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCX-bZLDHy-6wxuc5b8YInV_Mr7uYOTmgk",
    authDomain: "trinity-os-8edd0.firebaseapp.com",
    databaseURL: "https://trinity-os-8edd0-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "trinity-os-8edd0",
    storageBucket: "trinity-os-8edd0.firebasestorage.app",
    messagingSenderId: "692349337854",
    appId: "1:692349337854:web:ef24ead6e7362a5772a5af"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // Reset Database Functionality
  window.showResetConfirmation = function() {
    document.getElementById('confirmDialog').classList.add('show');
    document.getElementById('modalOverlay').style.display = 'block';
  };

  window.closeConfirmDialog = function() {
    document.getElementById('confirmDialog').classList.remove('show');
    document.getElementById('modalOverlay').style.display = 'none';
  };

  window.confirmReset = async function() {
    const resetButton = document.getElementById('resetButton');
    resetButton.disabled = true;
    resetButton.textContent = 'üîÑ Resetting...';
    
    try {
      const matrixRef = ref(db, 'matrixData');
      await remove(matrixRef);
      
      // Clear local data
      matrixData = {};
      
      // Reset UI
      const tbody = document.querySelector('#results-table tbody');
      tbody.innerHTML = '<tr><td colspan="6" class="no-results">Database reset. Waiting for new data...</td></tr>';
      
      // Clear canvas
      const rightMargin = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--right-margin'));
      ctx.fillStyle = '#0D1117';
      ctx.fillRect(0, 0, window.innerWidth - rightMargin, window.innerHeight);
      
      resetButton.textContent = '‚úì Reset Complete';
      resetButton.style.background = '#2ECC71';
      
      setTimeout(() => {
        resetButton.disabled = false;
        resetButton.textContent = 'üóëÔ∏è Reset DB';
        resetButton.style.background = '';
      }, 3000);
      
      console.log('Database reset successfully');
    } catch (error) {
      console.error('Error resetting database:', error);
      resetButton.textContent = '‚úó Reset Failed';
      resetButton.style.background = '#E74C3C';
      
      setTimeout(() => {
        resetButton.disabled = false;
        resetButton.textContent = 'üóëÔ∏è Reset DB';
        resetButton.style.background = '';
      }, 3000);
    }
    
    closeConfirmDialog();
  };

  // Attach reset button event
  document.getElementById('resetButton').addEventListener('click', showResetConfirmation);

  const canvas=document.getElementById('matrixCanvas'), ctx=canvas.getContext('2d',{alpha:false,desynchronized:true});
  let matrixData={}, currentColumn=0, cameraX=0, isFollowing=true;
  const CELL_W=50, TOTAL_ROWS=60, MAX_COLS=7200, BAR_SIZE=25; 
  let CELL_H=16, cachedStartOfWeek=null, panelUpdateTimer=null;
  const pad=(n,s=2)=>String(n).padStart(s,'0');

  function getWeekProgress(){
    const now = new Date();
    const day = now.getUTCDay();
    const hours = now.getUTCHours();
    const minutes = now.getUTCMinutes();
    const seconds = now.getUTCSeconds();
    const secsToday = (hours * 3600) + (minutes * 60) + seconds;
    let s = (day === 0) ? (6 * 86400) + secsToday : ((day - 1) * 86400) + secsToday;
    return Math.max(0, s);
  }

  function updateCurrentColumn() {
      const s = getWeekProgress();
      currentColumn = Math.floor(s / 60) % MAX_COLS;
      if(isFollowing) jumpToCurrent();
  }

  const dataRef = ref(db, 'matrixData');
  
  onValue(dataRef, (snapshot) => {
    const val = snapshot.val();
    if(val) {
        matrixData = val;
        document.getElementById('status').className = 'status live';
        updateCurrentColumn();
        if(panelUpdateTimer) clearTimeout(panelUpdateTimer);
        panelUpdateTimer = setTimeout(updatePanels, 100);
        
        // Auto-analyze on data update
        if (!window.analyzerInitialized) {
            window.analyzerInitialized = true;
            analyzeKingStreaks();
            startAutoRefresh();
        }
    }
  });

  function updatePanels(){
    let streakData = [];
    
    // Collect all row data with max streaks
    for(let r=0; r<TOTAL_ROWS; r++){
      let rM=0, gM=0;
      Object.values(matrixData).forEach(m=>{ 
        if(m[r]){ 
          if(m[r].c==='R') rM=Math.max(rM,m[r].s); 
          else gM=Math.max(gM,m[r].s); 
        }
      });
      
      // Calculate total occurrence for sorting
      let totalOccurrence = rM + gM;
      
      streakData.push({
        row: r,
        redMax: rM,
        greenMax: gM,
        totalOccurrence: totalOccurrence
      });
    }
    
    // Always sort by occurrence - highest to lowest
    streakData.sort((a, b) => b.totalOccurrence - a.totalOccurrence);
    
    // Build HTML
    let hS = '';
    let hI = '';
    
    streakData.forEach((data, index) => {
      const yPos = index * CELL_H;
      hS += `<div class="streak-row" onclick="window.openModal(${data.row})" style="position:absolute;top:${yPos}px;height:${CELL_H}px"><div class="streak-col red-side">${data.redMax?'x'+data.redMax:'--'}</div><div class="streak-col green-side">${data.greenMax?'x'+data.greenMax:'--'}</div></div>`;
      hI += `<div class="index-cell" style="top:${yPos}px;height:${CELL_H}px">${pad(data.row)}</div>`;
    });
    
    document.getElementById('streakPanel').innerHTML = hS; 
    document.getElementById('indexPanel').innerHTML = hI;
  }

  window.openModal = function(sec){
    document.getElementById('modalTitle').innerText=`${pad(sec)}_${pad(sec)}`;
    let rL=[], gL=[];
    Object.keys(matrixData).forEach(col => { if(matrixData[col][sec]){ const d = matrixData[col][sec]; if(d.c === 'R') rL.push(d.s); else gL.push(d.s); }});
    const sum=(a)=>{ const c={}; a.forEach(x=>c[x]=(c[x]||0)+1); return Object.keys(c).map(k=>({s:parseInt(k),c:c[k]})).sort((x,y)=>y.s-x.s); };
    document.getElementById('rD').innerHTML = sum(rL).map(i => `<div style="padding:14px;color:#FFF;border-bottom:1px solid rgba(255,255,255,0.1);font-family:'JetBrains Mono'">X${i.s} - ${i.c}</div>`).join('') || '<div style="padding:12px;opacity:0.5">No data</div>';
    document.getElementById('gD').innerHTML = sum(gL).map(i => `<div style="padding:14px;color:#FFF;border-bottom:1px solid rgba(255,255,255,0.1);font-family:'JetBrains Mono'">X${i.s} - ${i.c}</div>`).join('') || '<div style="padding:12px;opacity:0.5">No data</div>';
    document.getElementById('modal').style.display='flex'; 
    document.getElementById('modalOverlay').style.display='block';
  }

  function jumpToCurrent(){ 
    const rightMargin = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--right-margin'));
    cameraX = Math.max(0, (currentColumn*CELL_W)-(window.innerWidth-rightMargin-CELL_W)); 
  }
  
  window.closeModal = function(){ document.getElementById('modal').style.display='none'; document.getElementById('modalOverlay').style.display='none'; }

  window.onresize=()=>{ 
    const rightMargin = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--right-margin'));
    const dpr=window.devicePixelRatio||1; 
    canvas.width=(window.innerWidth - rightMargin)*dpr; 
    canvas.height=(window.innerHeight - BAR_SIZE)*dpr;
    canvas.style.width=(window.innerWidth - rightMargin)+'px'; 
    canvas.style.height=(window.innerHeight - BAR_SIZE)+'px';
    ctx.scale(dpr,dpr); 
    CELL_H=(window.innerHeight - (BAR_SIZE * 2))/TOTAL_ROWS;
    cachedStartOfWeek=null;
    jumpToCurrent();
  };

  function draw(){
    updateCurrentColumn();
    const rightMargin = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--right-margin'));
    ctx.fillStyle='#0D1117'; ctx.fillRect(0,0,window.innerWidth-rightMargin,window.innerHeight);
    
    if (!cachedStartOfWeek) {
      const now = new Date();
      const diff = now.getUTCDate() - (now.getUTCDay() === 0 ? 6 : now.getUTCDay() - 1);
      cachedStartOfWeek = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), diff, 0, 0, 0, 0));
    }

    ctx.save(); 
    ctx.translate(-cameraX,0);
    let sC=Math.max(0,Math.floor(cameraX/CELL_W)), eC=Math.min(MAX_COLS-1,Math.floor((cameraX+window.innerWidth-rightMargin)/CELL_W)+1);
    
    const beforeCol = currentColumn > 0 ? currentColumn - 1 : MAX_COLS - 1;
    let maxS = 0;
    const beforeData = matrixData[beforeCol];
    if (beforeData) {
      const vals = Object.values(beforeData);
      for(let i=0; i<vals.length; i++) if(vals[i].s > maxS) maxS = vals[i].s;
    }
    
    ctx.textAlign='center'; 
    ctx.textBaseline='middle';
    ctx.font='bold 10px "JetBrains Mono"';
    const pulseTime = Date.now() / 200;
    
    for(let a=sC; a<=eC; a++){
      const colData = matrixData[a];
      if(!colData) continue;
      const x=a*CELL_W, centerX=x+CELL_W/2;
      const keys = Object.keys(colData);
      
      for(let i=0; i<keys.length; i++){
        const r = keys[i];
        const d = colData[r];
        const isP = (a === beforeCol && d.s === maxS && d.s > 1);
        
        if(isP) {
          const scale = 1.0 + (0.2 * Math.abs(Math.sin(pulseTime)));
          const centerY = r*CELL_H+CELL_H/2;
          ctx.save();
          ctx.translate(centerX, centerY);
          ctx.scale(scale, scale);
          ctx.fillStyle = d.c==='R' ? '#FF4757' : '#2ECC71';
          ctx.fillText('x'+d.s, 0, 0);
          ctx.restore();
        } else {
          ctx.fillStyle = d.c==='R' ? '#FF4757' : '#2ECC71';
          ctx.fillText('x'+d.s, centerX, r*CELL_H+CELL_H/2);
        }
      }
    }

    ctx.restore();
    ctx.fillStyle = '#161B22'; ctx.fillRect(0, TOTAL_ROWS * CELL_H, window.innerWidth-rightMargin, BAR_SIZE);
    ctx.strokeStyle = '#30363D'; ctx.beginPath(); ctx.moveTo(0, TOTAL_ROWS * CELL_H); ctx.lineTo(window.innerWidth-rightMargin, TOTAL_ROWS * CELL_H); ctx.stroke();

    ctx.save();
    ctx.translate(-cameraX, 0);
    ctx.fillStyle='#8B949E'; ctx.font='700 10px "JetBrains Mono"'; ctx.textAlign='center'; ctx.textBaseline='middle'; 
    const barY = (TOTAL_ROWS*CELL_H) + (BAR_SIZE / 2);
    for(let a=sC; a<=eC; a++){
      if (a <= currentColumn) { 
        const lD=new Date(cachedStartOfWeek.getTime()+(a*60000));
        ctx.fillText(`${pad(lD.getUTCHours())}:${pad(lD.getUTCMinutes())}`, a*CELL_W+CELL_W/2, barY);
      }
    }
    ctx.restore(); 
    requestAnimationFrame(draw);
  }

  window.onresize(); 
  draw();

  // Export matrixData for analyzer
  window.getMatrixData = () => matrixData;
</script>

<script>
// King Streak Analyzer - Global Mode (All Rows)
let refreshInterval = null;
let countdownInterval = null;
let secondsRemaining = 60;

function analyzeKingStreaks() {
    const matrixData = window.getMatrixData();
    
    if (!matrixData || Object.keys(matrixData).length === 0) {
        return;
    }
    
    // Global analysis: Analyze all rows together
    let streakKings = {};
    
    // For each row (0-59)
    for (let row = 0; row < 60; row++) {
        // Collect all streaks for this row across all columns
        let redStreaks = {};
        let greenStreaks = {};
        
        const columns = Object.keys(matrixData).map(Number).sort((a, b) => a - b);
        
        for (let col of columns) {
            const cellData = matrixData[col][row];
            if (!cellData) continue;
            
            const color = cellData.c;
            const streak = cellData.s;
            
            if (color === 'R') {
                redStreaks[streak] = (redStreaks[streak] || 0) + 1;
            } else if (color === 'G') {
                greenStreaks[streak] = (greenStreaks[streak] || 0) + 1;
            }
        }
        
        // Calculate strengths for this row
        ['Red', 'Green'].forEach(color => {
            let d = color === 'Red' ? redStreaks : greenStreaks;
            Object.keys(d).forEach(lStr => {
                let l = parseInt(lStr);
                let count = d[l];
                let nxt = d[l+1] || 0;
                
                // STRENGTH FORMULA: How often streak breaks
                let strength = (1 - (nxt/count)) * 100;
                
                // Include ALL strengths (1% to 100%) with no minimum count
                if (strength >= 1 && strength <= 100) {
                    // Key by color and level only (not row) to keep only best per level
                    let key = `${color}-${l}`;
                    
                    // Keep only the HIGHEST CUR for each color-level combination
                    if (!streakKings[key] || count > streakKings[key].cur) {
                        streakKings[key] = { 
                            row: row,
                            col: color,
                            lvl: `X${l}‚ÜíX${l+1}`,
                            s: parseFloat(strength.toFixed(1)),
                            cur: count,
                            nxt: nxt
                        };
                    }
                }
            });
        });
    }
    
    renderResults(streakKings);
    updateLastRefreshTime();
}

function renderResults(kings) {
    const tbody = document.querySelector('#results-table tbody');
    tbody.innerHTML = '';
    
    // Sort by CUR (highest first)
    const sorted = Object.values(kings).sort((a, b) => b.cur - a.cur);
    
    if (sorted.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="no-results">No patterns found</td></tr>';
        return;
    }
    
    sorted.forEach(k => {
        const tr = document.createElement('tr');
        tr.className = k.col === 'Green' ? 'res-green' : 'res-red';
        tr.innerHTML = `
            <td>${k.col}</td>
            <td>${k.row.toString().padStart(2, '0')}</td>
            <td>${k.lvl}</td>
            <td>${k.cur}</td>
            <td>${k.nxt}</td>
            <td>${k.s}%</td>
        `;
        tbody.appendChild(tr);
    });
}

function updateLastRefreshTime() {
    const now = new Date();
    const time = now.toLocaleTimeString('en-US', { hour12: false });
    document.getElementById('lastUpdate').textContent = time;
}

function startCountdown() {
    secondsRemaining = 60;
    
    if (countdownInterval) clearInterval(countdownInterval);
    
    countdownInterval = setInterval(() => {
        secondsRemaining--;
        document.getElementById('countdown').textContent = secondsRemaining;
        
        if (secondsRemaining <= 0) {
            secondsRemaining = 60;
        }
    }, 1000);
}

function startAutoRefresh() {
    // Initial countdown
    startCountdown();
    
    // Refresh every 60 seconds
    refreshInterval = setInterval(() => {
        analyzeKingStreaks();
        startCountdown();
    }, 60000);
}

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    if (refreshInterval) clearInterval(refreshInterval);
    if (countdownInterval) clearInterval(countdownInterval);
});
</script>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js');
    });
  }
</script>

</body>
</html>
