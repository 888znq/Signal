<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>EURUSD ENTERPRISE - WIN PREDICTOR</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700;800&display=swap');

        :root {
            --bg-primary: #050505;
            --bg-secondary: #111111;
            --border-medium: #333333;
            --text-primary: #e0e0e0;
            --text-dim: #666666;
            --accent-red: #ff3b30;
            --accent-green: #34c759;
            --accent-gold: #ffcc00;
            --bar-size: 30px; 
            --w-streak: 60px;
            --w-index: 60px;
            --w-hunter: 220px;
            --w-sidebar: calc(var(--w-streak) + var(--w-index) + var(--w-hunter));
        }

        * { margin:0; padding:0; box-sizing:border-box; }
        body, html { 
            background: var(--bg-primary); 
            width: 100vw; 
            height: 100vh; 
            overflow: hidden; 
            font-family: 'JetBrains Mono', monospace; 
            color: var(--text-primary); 
        }

        #ui { 
            position: fixed; top: 0; left: 0; right: 0; height: var(--bar-size); 
            background: var(--bg-secondary); border-bottom: 1px solid var(--border-medium); 
            padding: 0 15px; z-index: 1000; display: flex; align-items: center; justify-content: space-between; 
        }

        #app-container { display: flex; height: 100vh; padding-top: var(--bar-size); }
        
        #stage { flex: 1; position: relative; background: var(--bg-primary); overflow: hidden; }
        canvas { display: block; width: 100%; height: 100%; }

        #sidebar { 
            width: var(--w-sidebar); background: var(--bg-secondary); 
            border-left: 1px solid var(--border-medium); display: flex; height: 100%; 
        }

        #col-streak { width: var(--w-streak); border-right: 1px solid var(--border-medium); overflow: hidden; }
        #col-index { width: var(--w-index); border-right: 1px solid var(--border-medium); background: var(--bg-secondary); overflow: hidden; }
        #col-hunter { width: var(--w-hunter); display: flex; flex-direction: column; background: var(--bg-secondary); }

        .streak-row { display: flex; width: 100%; border-bottom: 1px solid #222; cursor: pointer; }
        .streak-col { flex: 1; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 800; }
        .red-side { background: rgba(255, 59, 48, 0.05); color: var(--accent-red); }
        .green-side { background: rgba(52, 199, 89, 0.05); color: var(--accent-green); }
        .index-cell { width: 100%; display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: 700; color: var(--text-dim); border-bottom: 1px solid #222; }

        .hunter-body { flex: 1; overflow-y: auto; padding-bottom: 50px; }
        .h-row { padding: 12px 10px; border-bottom: 1px solid var(--border-medium); cursor: pointer; transition: 0.2s; }
        .h-row:hover { background: #1a1a1a; }

        @keyframes pulse-gold {
            0% { opacity: 0.8; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.02); color: #fff; }
            100% { opacity: 0.8; transform: scale(1); }
        }
        .pulse-val { animation: pulse-gold 1.5s infinite; color: var(--accent-gold); font-weight: 800; }

        /* Modal */
        #modalOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; backdrop-filter: blur(4px); }
        #modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 320px; height: 450px; background: var(--bg-secondary); border: 1px solid var(--border-medium); z-index: 2001; flex-direction: column; }
    </style>
</head>
<body>

<div id="ui">
    <div style="font-weight:800; font-size:11px; letter-spacing:1px;">WALLSPECTRUM <span style="color:var(--accent-gold)">WIN PREDICTOR</span></div>
    <div id="priceTag" style="color:var(--accent-green); font-weight:bold; font-size:13px; font-variant-numeric: tabular-nums;">0.00000</div>
</div>

<div id="app-container">
    <div id="stage"><canvas id="matrixCanvas"></canvas></div>
    <div id="sidebar">
        <div id="col-streak"></div>
        <div id="col-index"></div>
        <div id="col-hunter">
            <div style="padding:8px; font-size:9px; color:var(--text-dim); border-bottom:1px solid var(--border-medium); text-align:center; font-weight:bold;">TOP SIGNALS</div>
            <div class="hunter-body" id="hunterList"></div>
        </div>
    </div>
</div>

<div id="modalOverlay" onclick="closeModal()"></div>
<div id="modal">
    <div id="modalTitle" style="padding:12px; text-align:center; border-bottom:1px solid var(--border-medium); font-size:11px; font-weight:800; color:var(--accent-gold);"></div>
    <div style="flex:1; display:flex; overflow:hidden;">
        <div id="rD" style="flex:1; overflow-y:auto; border-right:1px solid #222;"></div>
        <div id="gD" style="flex:1; overflow-y:auto;"></div>
    </div>
    <button onclick="closeModal()" style="padding:10px; background:transparent; border:none; border-top:1px solid var(--border-medium); color:var(--text-dim); cursor:pointer; font-family:inherit; font-size:10px;">CLOSE</button>
</div>

<script>
    const canvas = document.getElementById('matrixCanvas');
    const ctx = canvas.getContext('2d', { alpha: false });
    const SYMBOL = "frxEURUSD";
    const DERIV_WS = "wss://ws.derivws.com/websockets/v3?app_id=1089";

    let matrixData = {};
    let currentColumn = 0;
    let CELL_H = 16;
    let CELL_W = 45;

    const ENGINE = Array.from({ length: 60 }, (_, i) => ({
        id: i, bucket_ts: 0, open: 0, close: 0,
        prev_color: 'Gray', prev_streak: 0,
        live_color: 'Gray', live_streak: 0,
        history: { Red: {}, Green: {} }
    }));

    const pad = (n) => String(n).padStart(2, '0');

    function processTick(price, epoch) {
        document.getElementById('priceTag').innerText = price.toFixed(5);
        ENGINE.forEach(s => {
            const bucket = Math.floor((epoch - s.id) / 60) * 60 + s.id;
            if (bucket > s.bucket_ts) {
                if (s.bucket_ts !== 0) {
                    const color = s.close > s.open ? 'Green' : (s.close < s.open ? 'Red' : 'Gray');
                    if (color !== 'Gray') {
                        if (color === s.prev_color) s.prev_streak++;
                        else { s.prev_color = color; s.prev_streak = 1; }
                        s.history[color][s.prev_streak] = (s.history[color][s.prev_streak] || 0) + 1;
                    } else { s.prev_streak = 0; s.prev_color = 'Gray'; }
                }
                s.bucket_ts = bucket; s.open = price; s.close = price;
            } else { s.close = price; }

            const lColor = s.close > s.open ? 'Green' : (s.close < s.open ? 'Red' : 'Gray');
            if (lColor === 'Gray') { s.live_streak = s.prev_streak; s.live_color = s.prev_color; }
            else if (lColor === s.prev_color) { s.live_streak = s.prev_streak + 1; s.live_color = lColor; }
            else { s.live_streak = 1; s.live_color = lColor; }
        });
    }

    function handleTick(tick) {
        const now = tick.epoch;
        processTick(tick.quote, now);
        currentColumn = Math.floor(now / 60) % 7200;
        if (!matrixData[currentColumn]) matrixData[currentColumn] = {};
        ENGINE.forEach(s => {
            matrixData[currentColumn][s.id] = { c: s.live_color[0], s: s.live_streak };
        });
        updateUI();
    }

    function updateUI() {
        let hS = '', hI = '';
        const live = matrixData[currentColumn] || {};
        for (let r = 0; r < 60; r++) {
            const cell = live[r];
            let rv = '--', gv = '--';
            if (cell) { if (cell.c === 'R') rv = cell.s; if (cell.c === 'G') gv = cell.s; }
            hS += `<div class="streak-row" onclick="openModal(${r})" style="height:${CELL_H}px"><div class="streak-col red-side">${rv}</div><div class="streak-col green-side">${gv}</div></div>`;
            hI += `<div class="index-cell" style="height:${CELL_H}px">${pad(r)}_${pad(r)}</div>`;
        }
        document.getElementById('col-streak').innerHTML = hS;
        document.getElementById('col-index').innerHTML = hI;
        scanBestWalls();
    }

    function scanBestWalls() {
        let walls = [];
        ENGINE.forEach(s => {
            ['Red', 'Green'].forEach(color => {
                const counts = s.history[color];
                for (let x = 1; x < 15; x++) {
                    const cur = counts[x] || 0;
                    const nxt = counts[x + 1] || 0;
                    if (cur >= 2) {
                        const wr = (1 - (nxt / cur)) * 100;
                        const score = wr * Math.log10(cur + 1);
                        walls.push({ id: s.id, color, level: `X${x}â†’X${x+1}`, wr, cur, score, pred: color === 'Red' ? 'CALL' : 'PUT' });
                    }
                }
            });
        });
        walls.sort((a, b) => b.score - a.score);
        document.getElementById('hunterList').innerHTML = walls.slice(0, 12).map(w => `
            <div class="h-row" onclick="openModal(${w.id})">
                <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                    <span style="color:var(--accent-gold); font-size:11px; font-weight:800;">#${pad(w.id)}</span>
                    <span class="pulse-val" style="font-size:11px;">${w.wr.toFixed(0)}% WIN</span>
                </div>
                <div style="display:flex; justify-content:space-between; font-size:10px;">
                    <span style="color:${w.color==='Red'?'var(--accent-red)':'var(--accent-green)'}; font-weight:bold;">${w.level}</span>
                    <span style="color:var(--text-dim);">VOL: ${w.cur}</span>
                </div>
                <div style="margin-top:6px; color:var(--accent-gold); font-size:9px; font-weight:800;">ACTION: ${w.pred}</div>
            </div>
        `).join('') || '<div style="padding:20px; text-align:center; font-size:10px; color:#444;">ANALYZING MARKET...</div>';
    }

    function openModal(id) {
        const s = ENGINE[id];
        document.getElementById('modalTitle').innerText = `OFFSET ${pad(id)} STATS`;
        const r = (o, c) => Object.keys(o).sort((a,b)=>b-a).map(k=>`<div style="padding:10px; border-bottom:1px solid #222; color:${c}; font-size:11px;"><b>X${k}</b> <span style="float:right">${o[k]}</span></div>`).join('');
        document.getElementById('rD').innerHTML = r(s.history.Red, '#ff3b30');
        document.getElementById('gD').innerHTML = r(s.history.Green, '#34c759');
        document.getElementById('modal').style.display = 'flex';
        document.getElementById('modalOverlay').style.display = 'block';
    }

    window.closeModal = () => {
        document.getElementById('modal').style.display = 'none';
        document.getElementById('modalOverlay').style.display = 'none';
    };

    function draw() {
        requestAnimationFrame(draw);
        const dpr = window.devicePixelRatio || 1;
        const w = canvas.width / dpr, h = canvas.height / dpr;
        ctx.fillStyle = "#050505"; ctx.fillRect(0, 0, w, h);

        const visible = Math.ceil(w / CELL_W) + 1;
        const start = currentColumn - visible + 2;

        for (let i = 0; i < visible; i++) {
            const colIdx = start + i;
            if (colIdx < 0) continue;
            const x = i * CELL_W;
            const data = matrixData[colIdx];

            for (let r = 0; r < 60; r++) {
                const y = r * CELL_H;
                if (data && data[r]) {
                    const cell = data[r];
                    ctx.fillStyle = cell.c === 'R' ? 'rgba(255, 59, 48, 0.2)' : (cell.c === 'G' ? 'rgba(52, 199, 89, 0.2)' : 'transparent');
                    ctx.fillRect(x + 1, y + 1, CELL_W - 2, CELL_H - 2);
                    if (cell.c !== 'Gray') {
                        ctx.fillStyle = cell.c === 'R' ? '#ff3b30' : '#34c759';
                        ctx.font = "bold 10px 'JetBrains Mono'";
                        ctx.textAlign = "center";
                        ctx.fillText(cell.s, x + CELL_W / 2, y + CELL_H / 2 + 4);
                    }
                }
                // Grid
                ctx.strokeStyle = "#111"; ctx.lineWidth = 0.5;
                ctx.strokeRect(x, y, CELL_W, CELL_H);
            }
        }
    }

    window.onresize = () => {
        const stage = document.getElementById('stage');
        const dpr = window.devicePixelRatio || 1;
        canvas.width = stage.clientWidth * dpr;
        canvas.height = stage.clientHeight * dpr;
        ctx.scale(dpr, dpr);
        CELL_H = stage.clientHeight / 60;
        updateUI();
    };

    function connect() {
        let ws = new WebSocket(DERIV_WS);
        ws.onopen = () => ws.send(JSON.stringify({ ticks: SYMBOL, subscribe: 1 }));
        ws.onmessage = (m) => { const d = JSON.parse(m.data); if (d.tick) handleTick(d.tick); };
        ws.onclose = () => setTimeout(connect, 3000);
    }

    window.onload = () => { window.onresize(); connect(); draw(); };
</script>

</body>
</html>
